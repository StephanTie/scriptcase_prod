# scriptcase_prod
Docker-compose scriptcase php-apps in nginx, mysql, phpmyadmin and phhp-fpm in production 

![This is an image](https://repository-images.githubusercontent.com/283847593/7454bc80-1bab-11eb-83fa-bb2f2e6f258f)


**How to install Scriptcase generated php applications on docker with nginx-proxy using nginx and mysql with ssl access **
** Additional solved the portability issue with wkhtmltopdf by generating a container for it                            **
date: 15–11–2021

**Introduction**
This manual describes how to get your applications generated by scriptcase into production using docker with nginx-proxy, letsencrypt, nginx and mysql and wkhtmltopdf dockerized. 
The standard installed application is a demo application from scriptcase.
It is running on ubuntu 18 and requires docker, docker-compose and ufw installed. Explanation how to install these you can easily find here or the other many manuals. Furthermore ensure that your servers and I like to stress this again and again if you use your applications exposed to the outside world are extremely hardened . (you can find enough examples of them with google)
Objective is to have the generated scriptcase php-applications accessible through the nginx-proxy protected by a certificate. Also I liked to have the benefit to test an older version and a new version of the generated scriptcase application in the same environment .
Prerequisites
Starting point: Ensure versions are equal or higher for:
- Ubuntu 18.04.4 LTS with ufw installed 
- docker version 18.09.7
- docker-compose 1.29.2

Ensure your production environment is safe and hardened otherwise  you get your data exposed. (ufw is up, fail2ban, sudo and no root users, ssh only with key and many other safety precautions steps you should  be familiar with)

With having this docker environment set up it is very easy to spin up an new copy of an environment and set up a stage environment.
Also new versions of scriptcase with new versions of php , nginx and mysql can be far more easily automatically installed and tested.
New applications and database updates which are pushed via ftp are deployed automatically.
Also it solves the problem to change settings for wkhtmltopdf per report and are settings like Landscape or A4.

**Steps**
Step 1 - Precautions for automatic iptable changes by docker.
When using docker first of all you do not want starting containers automatically opening ports and change the iptables. Also added standard dns.
edit daemon.json: sudo vi /etc/docker/daemon.json
{ "iptables" : false }
{ "dns": ["8.8.8.8", "8.8.8.4"] }
restart docker:
sudo systemctl start docker

Step 2 - Starting up nginx-proxy and letsencrypt-nginx-proxy-companion
Follow the steps defined on  https://github.com/StephanTie/nginx-proxy-letsencrypt

Step 3 - Ensure you have an A record pointing to your server 
project1.domain.com -> 111.222.333.444

Step 4 - Copy .env.template to .env and change the .env file

cp .env1.template .env
edit .env file and change all the items that have a mark <changeme> and <domain.com>.
Do not change the other settings. Do this later after the first initial run works

Step 5 Run install for project1
sudo firststeponly.sh 1

Step 6 Configure Scriptcase production Go to https://project1.domain.com/_lib/prod
- Login with scriptcase and set new password 
- edit pdf server in production settings to /app
- edit database connection option conn_example and change Server/Host to mysql-project and save
![afbeelding](https://user-images.githubusercontent.com/8845918/147996147-8448611b-33e6-4878-b6f8-8b304a215315.png)
- Leave your browser and startup again to check if your settings were saved
- Now you can browse to https://project1.<domain.com>   for which you fil in your domain

Step 7 Starting the second project with connection to the same database with sudo ./firststeponly 2 and follow the same steps as above but with specifics of project2
    
  
** Special options  **
1. Automatic updates in case updates are pushed to directory app_install/project{1..n} or directory mysql_install or with help of the pure-ftpd server (see project pureftpd)
Start automatic update process  (change /data/docker to your directory where your project reside)
- screen -dmS PUBLISH_SCRIPTCASE  /data/docker/scriptcase_prod/publish_scriptcase.sh

2. Wkhtmltopdf and scriptcase 
This container and the script can also be used on its own and can be accessed via curl
Settings can be defined in a seperate file per report in the /pdf_ini location.  Copy the example grid_customers_pdf.ini.example (without .example) to this directory
And check if the report is using the other settings
  
**Remarks:**
If you encounter problems most of the time it is related with not having the proper rights although the scripts changes them correctly.


**Commands:**
docker-compose up -d        : starts up project1

docker-compose build        : Creating docker specific docker images for project1

docker-compose down        : Stops project1
     
docker-compose -f dc_project2 --env_file .env2 up -d : starts up project2
docker-compose -f dc_project2 --env_file .env2 build : Creating docker specific docker images for project1
docker-compose -f dc_project2 --env_file .env2 down  : stops project2

screen -dmS PUBLISH_SCRIPTCASE ./publish_scriptcase.sh 1:  Checks if files are placed in app_install/project1 or mysql_install or ../pure-ftpd/data/scriptcase/project1 dir and updates the projects automatically
screen -dmS PUBLISH_SCRIPTCASE ./publish_scriptcase.sh 2:  Checks if files are placed in app_install/project2 or ../pure-ftpd/data/scriptcase/project2 dir

Checking if wkhtmltopdf works:
curl -v -X POST -H 'Content-Type: application/json' -d '{"args":["Hello","Letter","--orientation","Portrait","--header-right","[page]", http://wkhtmltopdf1:4000/commands/hello?wait=true&force_unique_key=true   and curl -v -H http://wkhtmltopdf1:4000/commands/hello?key=<fill in key received>    

curl -v -X POST -H 'Content-Type: application/json' -d '{"args":["--page-size","Letter","--orientation","Portrait","--header-right","[page]","/app/_lib/tmp/sc_grid_customers_html_srohjjdvj89f8r2148nm22damc.html","/app/_lib/tmp/sc_pdf_06a6822b6a707fe23a99808a1df15641_grid_customers.pdf"]}' http://wkhtmltopdf-project2:4000/commands/wkhtmltopdf?wait=true&force_unique_key=true   
    
Projectstructure:
   
```sh
── app
│   ├── project1
│   │   ├── grid_customers
│   │   ├── grid_<others>    
│   │   ├── _lib
│   │   │   └── tmp
│   │   │   └── prod
│   │   └── pdf_ini
│   └── project2
│       ├── grid_customers
│       ├── grid_<others>    
│       ├── _lib
│       │   └── tmp
│       │   └── prod
│       └── pdf_ini
├── app_install
│   ├── project1
│   │   └── history
│   └── project2
│       └── history
├── db_project
│   ├── mysql
│   ├── performance_schema
│   ├── securityexample
│   └── sys
├── dockerfiles
│   ├── Flask-Shell2HTTP
│   │   ├── conf
│   │   ├── docs
│   ├── project1
│   └── project2
├── mysql_conf
├── mysql_install
│   └── history
├── nginx_conf
│   ├── project1
│   │   └── vhost
│   └── project2
│       ├── log
│       └── vhost
├── nginx_log
│   ├── project1
│   └── project2
├── php_conf
│   ├── project1
│   │   ├── iniscan
│   │   └── phpext
│   └── project2
│       ├── iniscan
│       └── phpext
└── pma_conf
    └── sessions
```
##   Special Thanks to the opensource projects from
- Eshaan Bansal for his contribution on github eshaan7/Flask-Shell2HTTP
- jwilder/nginx-proxy 
- jrcs/letsencrypt-nginx-proxy-companion
- surnet/wkhtmltopdf   
- To many others who share their knowledge on github and stackoverflow 
